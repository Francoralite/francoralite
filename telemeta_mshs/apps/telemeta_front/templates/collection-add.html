
{% extends "collection.html" %}
{% load bootstrap3 %}
{% load i18n %}
{% load data_display %}
{% load markdown_extra %}

{# Load CSS and JavaScript #}
{% bootstrap_css %}
{% bootstrap_javascript %}

{% block javascript %}
  {{ block.super }}

  <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/3.1.3/js/jasny-bootstrap.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.17/vue.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-select/2.5.1/vue-select.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>

{% endblock %}

{% block stylesheets %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js-bootstrap-css/1.2.1/typeaheadjs.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/3.1.3/css/jasny-bootstrap.min.css">
{% endblock %}

{% block title %}
   {{ block.super}}
   {% if id %}
   {% trans "Modification" %}
   {% else %}
   {% trans "Création" %}
   {% endif %}
{% endblock %}

{% block title_buttons %}
{% endblock %}

{% block content %}
{{ form.media }}
<div class="container">
  <div id="app">
    {% if id %}
    <form action="{% url "collection-edit" id %}" method="POST">
    {% else %}
    <form action="{{request.path}}" method="POST">
    {% endif %}
      {% csrf_token %}

      <div class="container_line">
        {% bootstrap_field form.mission layout='vertical' %}
        {% bootstrap_field form.title layout='vertical' %}
        {% bootstrap_field form.alt_title layout='vertical' %}
      </div>

      <!-- Collectors -->
      <div class="container_data">
        <label class="control_label">{% trans "Enquêteurs" %}</label>
        <v-select
          multiple
            v-model="collectors"
            label="first_name"
            :filterable="false"
            @search="onSearchCollectors"
            :options="optionsCollectors">
            <template slot="option" slot-scope="option">
              ${ option.first_name } ${ option.last_name } -
              <a :href="option.url"
                onclick="window.open(this.href); return false;">
                <i>Fiche...</i></a>
            </template>
            <template slot="selected-option" slot-label="countryName" scope="option">
              <a :href="option.url"
              onclick="window.open(this.href); return false;">
              ${ option.first_name } ${ option.last_name }</a>
            </template>
        </v-select>
      </div>
      <input name="collectors" type="hidden" :value="JSON.stringify(collectors)" />


      <!-- Informers -->
      <div class="container_data">
        <label class="control_label">{% trans "Informateurs" %}</label>
        <v-select
          multiple
            v-model="informers"
            label="first_name"
            :filterable="false"
            @search="onSearchInformers"
            :options="optionsInformers">
            <template slot="option" slot-scope="option">
              ${ option.first_name } ${ option.last_name } -
              <a :href="option.url"
                onclick="window.open(this.href); return false;">
                <i>Fiche...</i></a>
            </template>
            <template slot="selected-option" slot-scope="option">
              <a :href="option.url"
              onclick="window.open(this.href); return false;">
              ${ option.first_name } ${ option.last_name }</a>
            </template>
        </v-select>
      </div>
      <input name="informers" type="hidden" :value="JSON.stringify(informers)" />

      {% bootstrap_field form.descriptions layout='vertical' %}
      {% bootstrap_field form.description layout='vertical' %}
      <div class="block-grey">
        <h2>{% trans "Enregistrement" %}</h2>
        <div class="container_line">
          {% bootstrap_field form.recording_context layout='vertical'%}
          {% bootstrap_field form.record_from_year layout='vertical' %}
          {% bootstrap_field form.record_to_year layout='vertical' %}
          {% bootstrap_field form.year_published layout='vertical' %}
        </div>
      </div>

      <div class="block-grey">
        <h2>{% trans "Localisation" %}</h2>
          <!-- Locations -->
          <div class="container_data">
            <label class="control_label">{% trans "Lieux" %}</label>
            <v-select
            multiple
            v-model="locations"
            label="name"
            :filterable="false"
            @search="onSearchLocations"
            :options="optionsLocations">
            <template slot="option" slot-scope="option">
              <b>${ option.code }</b>
              <p>${ option.name }</p>
              <p><a :href="option.url"
                onclick="window.open(this.href); return false;">Fiche...</a></p>
            </template>
            <template slot="selected-option" slot-scope="option">
              <a :href="option.url"
              onclick="window.open(this.href); return false;">
              ${ option.code }</a>
            </template>
          </v-select>
        </div>
        <div class="container_line">
          {% bootstrap_field form.location_details layout='vertical' %}
          {% bootstrap_field form.cultural_area layout='vertical' %}
        </div>
      </div>
      {% bootstrap_field form.language layout='vertical' %}
      <div class="block-grey">
        <h2>{% trans "Éditeur" %}</h2>
        <div class="container_line">
          {% bootstrap_field form.publisher_collection layout='vertical' %}
        </div>
      </div>

      <div class="container_line">
        {% bootstrap_field form.booklet_author %}
        {% bootstrap_field form.metadata_author %}
      </div>

      <div class="container_line">
        {% bootstrap_field form.code layout='vertical' %}
        {% bootstrap_field form.code_partner layout='vertical' %}
      </div>

      <div class="container_line">
        {% bootstrap_field form.booklet_description layout='vertical' %}
        {% bootstrap_field form.comment layout='vertical' %}
      </div>
      {% bootstrap_field form.physical_items_num layout='vertical' %}
      {% bootstrap_field form.auto_period_access layout='vertical' %}
      {% bootstrap_field form.media_type layout='vertical' %}
      {% bootstrap_field form.legal_rights layout='vertical' %}
      {% bootstrap_field form.public_access layout='vertical' %}

      <div class="block-grey">
        <h2>{% trans "Voix/Instruments" %}</h2>
        <div class="container_line">

        </div>
      </div>

      {% buttons_form %}
    </form>
  </div>
</div>

<script type="application/javascript">
    Vue.component('v-select', VueSelect.VueSelect)

    new Vue({
      delimiters: ['${', '}'],
      el: '#app',
      data: {
          collectors: [],
          optionsCollectors: [],
          informers: [],
          optionsInformers: [],
          locations: [],
          optionsLocations: []
      },
      watch: {
      },
      computed: {
      },
      methods: {
        onSearchCollectors(search, loading) {
          loading(true);
          this.searchCollectors(loading, search, this);
        },
        searchCollectors: _.debounce((loading, search, vm)=>
        {
          axios.get(
          `/api/authority/?is_collector=true&ordering=first_name+last_name&search=${escape(search)}`
          ).then(
          res => {
            for(i = 0; i < res.data.length; i++) {
              res.data[i].url= "/authority/"+res.data[i].id;
            };
              vm.optionsCollectors = res.data;
           });
           loading(false);
         }),
         onSearchInformers(search, loading) {
           loading(true);
           this.searchInformers(loading, search, this);
         },
         searchInformers: _.debounce((loading, search, vm)=>
         {
           axios.get(
           `/api/authority/?is_informer=true&ordering=first_name+last_name&search=${escape(search)}`
           ).then(
           res => {
             for(i = 0; i < res.data.length; i++) {
               res.data[i].url= "/authority/"+res.data[i].id;
             };
               vm.optionsInformers = res.data;
            });
            loading(false);
          }),
          onSearchLocations(search, loading) {
            loading(true);
            this.searchLocations(loading, search, this);
          },
          searchLocations: _.debounce((loading, search, vm)=>
          {
            axios.get(
            `/api/locationgis/?ordering=code&search=${escape(search)}`
            ).then(
            res => {
              for(i = 0; i < res.data.length; i++) {
                res.data[i].url= "/location_gis/"+res.data[i].id;
              };
                vm.optionsLocations = res.data;
             });
             loading(false);
           }),
             getLocations:  function() {
                 axios.get('/api/locationgis/?ordering=code')
                 .then(
                 res => {
                   for(i = 0; i < res.data.length; i++) {
                     res.data[i].url= "/location_gis/"+res.data[i].id;
                   }
                   this.optionsLocations = res.data;
                  });
              },
          getCollectors: function(){
            // Get the collectors
            axios.get(`/api/collection/${escape({{id}})}/collectors`)
            .then(
            res => {
              for(i = 0; i < res.data.length; i++) {
                res.data[i].collector.url="/authority/"+res.data[i].collector.id;
              }
              var listCollectors = [];
              for( var item in res.data) {
                // Fill the list of collectors
                listCollectors.push(res.data[item].collector)
              }
              // Use the list of collectors to feeds the collectors select
              this.collectors = listCollectors;
             });
          },
          getInformers: function(){
            // Get the informers
            axios.get(`/api/collection/${escape({{id}})}/informer`)
            .then(
            res => {
              for(i = 0; i < res.data.length; i++) {
                res.data[i].informer.url="/authority/"+res.data[i].informer.id;
              }
              var listInformers = [];
              for( var item in res.data) {
                // Fill the list of informers
                listInformers.push(res.data[item].informer)
              }
              // Use the list of informers to feeds the informers select
              this.informers = listInformers;
             });
          },
       },
       mounted: function () {
         {% if id %}
           this.getCollectors();
           this.getInformers();
         {% endif %}
            //this.getLocations();
       }
    })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.4"></script>

{% markdown_editor "id_descriptions" %}
{% markdown_editor "id_location_details" %}
{% markdown_editor "id_booklet_description" %}
{% markdown_editor "id_comment" %}

{{ form.media.js }}
{% endblock %}
