---

# Docker compose to build Telemeta meta project

version: '2.1'

networks:
  keycloak: {}
  francoralite: {}
  services:
    external:
      name: 'services'

services:
  data:
    image: 'debian:jessie'
    networks:
      - 'francoralite'
    volumes:
       - './data/media/:/srv/media'
       - './data/backup/:/srv/backup'
       - './data/static:/srv/static'
       - './data/bower:/srv/bower'
       - './data/log/nginx:/var/log/nginx'
       - './data/log/uwsgi:/var/log/uwsgi'
    command: 'true'

  db:
    image: 'mysql:8.0.2'
    volumes:
        #- './telemeta_mshs/apps/Telemeta/scripts/:/srv/scripts'
      - 'francoralite_db:/var/lib/mysql'
    networks:
      - 'francoralite'
    volumes_from:
      - 'data'
    env_file:
      - './francoralite-env/prod.env'
    healthcheck:
      test: ["CMD-SHELL", "mysql -u $${MYSQL_USER} -p$${MYSQL_PASSWORD} -e 'SHOW DATABASES;'"]
      interval: '30s'
      timeout: '2s'
      retries: 3

  broker:
    image: 'redis'
    networks:
      - 'francoralite'

  app:
    build:
      context: .
    networks:
      - 'services'
      - 'francoralite'
    volumes:
      - './:/srv/app'
      - './scripts:/srv/scripts'
        #- './telemeta_mshs/apps/Telemeta/app/enumeration:/srv/app/enumeration'
        #- './telemeta_mshs/apps/Telemeta/app/fixtures:/srv/app/fixtures'
      - './telemeta_mshs/settings/base.py:/srv/app/settings.py'
        #- './telemeta_mshs/apps/Telemeta/app/settings.py:/srv/app/telemeta_settings.py'
        #- './telemeta_mshs/apps/Telemeta/app/robots.txt:/srv/app/telemeta_mshs/robots.txt'
      - './etc/keycloak/auth.json:/tmp/authorization_config.json'
      - './data/media/:/srv/media'
      - './data/static:/srv/static'
      - './data/bower:/srv/bower'
    env_file:
      - './francoralite-env/prod.env'
      - './francoralite-env/app.env'
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 8000"]
      interval: '10s'
      timeout: '2s'
      retries: 20
    command: '/bin/bash /srv/scripts/start_api.sh'
    depends_on:
      db:
        condition: 'service_healthy'

  nginx:
    image: 'nginx'
    depends_on:
      - 'app'
      - 'keycloak'
      - 'phpmyadmin'
    networks:
      - 'services'
    volumes:
      - './etc/nginx.conf:/etc/nginx/conf.d/default.conf'
    volumes_from:
      - 'data'

  phpmyadmin:
    image: 'nazarpc/phpmyadmin'
    networks:
      - 'services'
      - 'francoralite'
    environment:
      - ABSOLUTE_URI=http://phpmyadmin.francoralite.localhost:50000/phpmyadmin/

  keycloak:
    image: "${KEYCLOAK_IMAGE}:${KEYCLOAK_VERSION}"
    restart: 'unless-stopped'
    logging:
      driver: 'json-file'
      options:
        max-size: "${LOGGING_MAX_SIZE}"
        max-file: "${LOGGING_MAX_FILE}"
    env_file:
      - './francoralite-env/keycloak.env'
    networks:
      keycloak:
        aliases:
          - 'keycloak'
      services:
        aliases:
          - 'keycloak'
          - 'keycloak.francoralite.localhost'
    depends_on:
      - 'keycloak_db'

  keycloak_db:
    image: "${POSTGRES_IMAGE}:${POSTGRES_VERSION}"
    restart: 'unless-stopped'
    logging:
      driver: 'json-file'
      options:
        max-size: "${LOGGING_MAX_SIZE}"
        max-file: "${LOGGING_MAX_FILE}"
    env_file:
      - './francoralite-env/keycloak_database.env'
    networks:
      - 'keycloak'
    volumes:
      - 'keycloak_db:/var/lib/postgresql/data'

volumes:
  francoralite_db: {}
  keycloak_db: {}
